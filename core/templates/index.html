<!DOCTYPE html>
<html lang="es">
  <head>
    {% load static %}
    <meta charset="UTF-8" />
    <title>Healthcare Translator</title>
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  </head>
  <body>
    <h1>ğŸ©º Healthcare Translator</h1>

    <div class="form-container">
      <form id="translateForm">
        <label>Translate from:</label>
        <select name="language_from" id="language_from">
          <option value="en-US">English</option>
          <option value="es-MX">EspaÃ±ol</option>
          <option value="fr-FR">FranÃ§ais</option>
          <option value="de-DE">Deutsch</option></select
        ><br /><br />

        <textarea
          disabled
          name="text"
          id="recognizedText"
          rows="4"
          cols="60"
          placeholder="Press ğŸ™ï¸ Talk to start the recording"
        ></textarea
        ><br /><br />

        <button type="button" id="startBtn">ğŸ™ï¸ Talk</button>
      </form>
      <br /><br />

      <form id="translateTo">
        <label>Translate to:</label>

        <select name="language_to" id="language_to">
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="fr">French</option>
          <option value="de">German</option></select
        ><br /><br />

        <h4>Translation:</h4>
        <p id="output"></p>
        <audio id="audio" controls style="display: none"></audio>
      </form>
    </div>

    <script>
      const startBtn = document.getElementById("startBtn");
      const recognizedText = document.getElementById("recognizedText");
      const output = document.getElementById("output");
      const audio = document.getElementById("audio");
      const languageSelect = document.getElementById("language_to");

      if ("webkitSpeechRecognition" in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;

        startBtn.addEventListener("click", () => {
          recognition.lang = languageSelect.value; // 'es-MX', 'en-US', etc.
          recognition.start();
        });

        recognition.onresult = async (event) => {
          const transcript = event.results[0][0].transcript;
          recognizedText.value = transcript;

          // Enviar automÃ¡ticamente a /translate/
          const formData = new FormData();
          formData.append("text", transcript);
          formData.append("language", languageSelect.value);

          try {
            const response = await fetch("/translate/", {
              method: "POST",
              body: formData,
            });

            const data = await response.json();
            output.innerText = data.translated || "âŒ No se pudo traducir";

            if (data.audio_url) {
              audio.src = data.audio_url;
              audio.style.display = "block";
              audio.load();
              audio.play();
            } else {
              audio.style.display = "none";
            }
          } catch (error) {
            console.error("âŒ Error al traducir:", error);
            output.innerText = "âŒ Error en la traducciÃ³n";
            audio.style.display = "none";
          }
        };

        recognition.onerror = (event) => {
          console.error("Reconocimiento de voz fallÃ³:", event.error);
          alert("Error: " + event.error);
        };
      } else {
        alert("Tu navegador no soporta reconocimiento de voz.");
      }
    </script>
  </body>
</html>
